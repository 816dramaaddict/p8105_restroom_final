---
title: "Clutser Accessibility of Subway Stations"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, 
                      message = FALSE)
library(tidyverse)
library(tidyr)
library(ggplot2)
library(sf)
library(plotly)
library(forcats)
library(klaR)
library(knitr)
library(kableExtra)
```
 

# How Accessible Subways Are?

```{r data_cleaning}
subway_df = read_csv("./Data/NYC_Transit_Subway_Entrance_And_Exit_Data.csv") %>% 
  janitor::clean_names()
# Clean subway data
subway_cleaned = subway_df %>% 
  # select(-ada_notes, -staff_hours, -north_south_street, -east_west_street, -corner) %>% 
  mutate(
    entrance_type = factor(
      entrance_type,
      levels = c("Stair", "Easement", "Door", "Walkway", "Escalator", "Ramp", "Elevator")
    )
  ) %>% 
  mutate(
    staffing = factor(
      staffing,
      levels = c("NONE", "Spc Ev", "PART", "FULL")
    )
  )

# Importing NYC map
nyc_map = st_read(here::here('NYC', 'nyc.shp'), quiet = TRUE)
nycmap = st_transform(nyc_map, crs = 4326)
```

<br><br>

### Are there ADA compliances?

:::: {style="display: flex;"}

::: {}


```{r, fig.align='center', fig.width=8, fig.height=8}
subway_cleaned %>% 
  ggplot() +
    geom_sf(
      data = nyc_map, fill = NA
    ) + 
    geom_point(
      aes(x = station_longitude, y = station_latitude, color = ada),
      size = 2.5, alpha = 0.5) +
  coord_sf() +
  theme_void(base_size = 10) +
  theme(legend.position = 'bottom') +
  guides(color = guide_legend(
    title.position = "top",
    override.aes = list(size = 3))) +
  scale_color_manual(values = c("FALSE" = "aquamarine3", "TRUE" = "slateblue3")) +
  labs(color = "ADA Compliance")

```

:::
  
  
:::{}

<br><br>
<br><br>

```{r, fig.align='center', fig.width=4, fig.height=3.5, fig.align='center'}
subway_cleaned %>% 
  group_by(ada) %>% 
  count(ada) %>% 
  plot_ly (x = ~ada, 
           y = ~n, 
           color = ~ada,
           type = "bar") %>% 
  layout(
    xaxis = list(title = "Ada Complaince"),   
    yaxis = list(title = "Number of Stations") 
  )
```

:::
  
::::

### What are their entrance types?

```{r}
subway_cleaned %>% 
  group_by(entrance_type) %>% 
  count(entrance_type) %>% 
  ungroup() %>%
  mutate(entrance_type = fct_reorder(entrance_type, n, .desc = TRUE)) %>%
  plot_ly (x = ~entrance_type, y = ~n, 
           color = ~entrance_type,
           type = "bar", colors = "viridis") %>% 
  layout(
    xaxis = list(title = "Entrance Type"),   
    yaxis = list(title = "Number of Stations")
  )
```

### Other Accessibilities and Amenities

```{r}
subway_cleaned %>% 
  ggplot() +
    geom_sf(
      data = nyc_map, fill = NA
    ) + 
    geom_point(
      aes(x = station_longitude, y = station_latitude, color = free_crossover),
      size = 2.5, alpha = 0.5) +
  coord_sf() +
  theme_void(base_size = 10) +
  theme(legend.position = 'bottom') +
  guides(color = guide_legend(
    title.position = "top",
    override.aes = list(size = 3))) +
  labs(color = "Free Crossover")

subway_cleaned %>% 
  group_by(free_crossover) %>% 
  count(free_crossover) %>% 
  plot_ly (x = ~free_crossover, 
           y = ~n, 
           color = ~free_crossover,
           type = "bar") %>% 
  layout(
    xaxis = list(title = "Free Crossover"),   
    yaxis = list(title = "Number of Stations") 
  )
```

```{r}
subway_cleaned %>%
  group_by(staffing) %>%
  count(staffing) %>%
  ungroup() %>%
  mutate(staffing = fct_reorder(staffing, n, .desc = TRUE)) %>%
  plot_ly(
    x = ~staffing, 
    y = ~n,
    color = ~staffing,
    type = "bar", 
    colors = "viridis"
  ) %>%
  layout(
    xaxis = list(title = "Staffing"),   
    yaxis = list(title = "Number of Stations")
  )
```


# Cluster Subway's Accessibility

### When NOT considering restroom access,

```{r}
# Convert binary variable to factors
subway_cleaned %>% 
  ada <- factor(ada, levels = c("FALSE", "TRUE")) %>% 
  free_crossover <- factor(free_crossover, levels = c("FALSE", "TRUE"))

# Select the Variables for Clustering
clustering_data <- subway_cleaned %>%
  select(entrance_type, staffing, ada, restroom_accessibility)

set.seed(123)  # For reproducibility
km_result <- kmodes(clustering_data, modes = 3, iter.max = 10)
```


```{r}
subway_cleaned_with_clusters <- subway_cleaned %>%
  mutate(cluster = km_result$cluster)

# 2. Inspect cluster modes (the "central" values of each cluster)
modes_df <- as.data.frame(km_result$modes)
modes_df$cluster <- 1:nrow(modes_df)
modes_df <- modes_df %>% select(cluster, everything())

# Display cluster modes in a nice table
kable(modes_df, caption = "Cluster Modes") %>%
  kable_styling(full_width = FALSE)

# 3. Summarize the distribution of a key variable (e.g., entrance_type) across clusters
entrance_distribution <- subway_cleaned_with_clusters %>%
  count(cluster, entrance_type) %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n))

# Display as a table
kable(entrance_distribution, caption = "Entrance Type Distribution by Cluster") %>%
  kable_styling(full_width = FALSE)

# 4. Visualize the distribution of entrance_type by cluster
ggplot(entrance_distribution, aes(x = factor(cluster), y = prop, fill = entrance_type)) +
  geom_col(position = "dodge") +
  scale_fill_viridis_d() +
  labs(
    title = "Distribution of Entrance Types by Cluster",
    x = "Cluster",
    y = "Proportion",
    fill = "Entrance Type"
  ) +
  theme_minimal()

# 5. Similarly, visualize another variable, such as staffing, by cluster
staffing_distribution <- subway_cleaned_with_clusters %>%
  count(cluster, staffing) %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n))

ggplot(staffing_distribution, aes(x = factor(cluster), y = prop, fill = staffing)) +
  geom_col(position = "dodge") +
  scale_fill_viridis_d() +
  labs(
    title = "Distribution of Staffing Levels by Cluster",
    x = "Cluster",
    y = "Proportion",
    fill = "Staffing"
  ) +
  theme_minimal()
```

### When considering restroom access,